stages:
  - lint
  - build
  - docker
  - deploy

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "master" && $CI_PIPELINE_SOURCE == "push"
    - if: $CI_COMMIT_BRANCH == "develop" && $CI_PIPELINE_SOURCE == "push"
    - if: $CI_PIPELINE_SOURCE == "web"

lint-and-typecheck:
  stage: lint
  image: node:18-alpine
  cache:
    key:
      files:
        - package-lock.json
    paths:
      - .npm/
  script:
    - npm ci --cache .npm/
    - npm run build -w @planning-poker/shared
    - npm run db:generate -w @planning-poker/backend
    - npm run typecheck

build:
  stage: build
  image: node:18-alpine
  needs: [lint-and-typecheck]
  cache:
    key:
      files:
        - package-lock.json
    paths:
      - .npm/
  script:
    - npm ci --cache .npm/
    - npm run build -w @planning-poker/shared
    - npm run db:generate -w @planning-poker/backend
    - npm run build -w @planning-poker/backend
    - npm run build -w @planning-poker/frontend

docker-build:
  stage: docker
  image: docker:27
  needs: [build]
  services:
    - docker:27-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
    BACKEND_IMAGE: $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHA
    FRONTEND_IMAGE: $CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHA
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build -f docker/backend.Dockerfile --target production -t $BACKEND_IMAGE .
    - docker build -f docker/frontend.Dockerfile --target production -t $FRONTEND_IMAGE .
    - docker push $BACKEND_IMAGE
    - docker push $FRONTEND_IMAGE

deploy:
  stage: deploy
  image: docker:27
  needs: [docker-build]
  rules:
    - if: $CI_COMMIT_BRANCH == "master" && $CI_PIPELINE_SOURCE == "push"
    - if: $CI_PIPELINE_SOURCE == "web"
  variables:
    DOCKER_TLS_CERTDIR: ""
    BACKEND_IMAGE: $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHA
    FRONTEND_IMAGE: $CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHA
  before_script:
    - apk add --no-cache openssh-client curl
    - eval $(ssh-agent -s)
    - printf '%s' "$DEPLOY_SSH_KEY" | tr '|' '\n' | base64 -d | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh && chmod 700 ~/.ssh
    - ssh-keyscan -H $DEPLOY_HOST >> ~/.ssh/known_hosts
  script:
    - ssh $DEPLOY_USER@$DEPLOY_HOST "docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY"
    - DOCKER_HOST=ssh://$DEPLOY_USER@$DEPLOY_HOST docker compose -f docker-compose.prod.yml pull
    - DOCKER_HOST=ssh://$DEPLOY_USER@$DEPLOY_HOST docker compose -f docker-compose.prod.yml up --no-build -d
    - DOCKER_HOST=ssh://$DEPLOY_USER@$DEPLOY_HOST docker image prune -f
    - sleep 30
    - curl -f -u "$BASIC_AUTH_USER:$BASIC_AUTH_PASS" $DEPLOY_URL/health
